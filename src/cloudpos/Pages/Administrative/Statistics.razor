@attribute [Authorize(Roles = AuthorizationHandler.AdminRole)]
@page "/Administrative/Statistics"
@layout Shared.AdminPageLayout
@code
{
    private const string OptionClass = "btn-outline-secondary border-0 btn-sm";
    private const string SelectedOptionClass = "btn-secondary btn-sm";
    private string CurrencyFormat(int x) => x == 0 ? "￦0": $"￦{x:#,###}";
}

<PageTitle>통계</PageTitle>

<div class="container py-4">
    <div class="d-flex justify-content-center align-items-center mb-4">
        <button class="btn btn-outline-secondary" @onclick="() => ChangeMonth(-1)">◀ 이전 달</button>
        <h3 class="mx-4 mb-0">@_selectedMonth.ToString("yyyy년 MMMM", _koCulture)</h3>
        <button class="btn btn-outline-secondary" @onclick="() => ChangeMonth(1)" disabled="@IsNextMonthDisabled()">다음 달 ▶</button>
    </div>

    @if (_isLoading)
    {
        <div class="d-flex justify-content-center align-items-center my-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
            <span class="ms-3 fs-4">@_selectedMonth.ToString("M월") 통계 데이터를 불러오는 중입니다...</span>
        </div>
    }
    else
    {
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card shadow-sm h-100">
                    <div class="card-header text-center">
                        <h5 class="card-title mb-0">주간 판매 금액</h5>
                    </div>
                    
                    <div class="card-body">
                        @if (!HasSalesDataForCurrentWeek)
                        {
                            <div class="d-flex flex-column justify-content-center align-items-center text-muted" style="height:450px; width:100%">
                                <i class="bi bi-exclamation-lg fs-1 mt-5"></i>
                                <h6>통계 없음</h6>
                            </div>
                        }
                        else
                        {
                            <div class="chart-container" style="position: relative; height:450px; width:100%">
                                <canvas id="salesChart"></canvas>
                            </div>
                        }
                    </div>
                    <div class="card-footer d-flex justify-content-center align-items-center">
                        <button class="btn btn-sm btn-outline-secondary" @onclick="() => ChangeWeek(-1)" disabled="@(_selectedWeekIndex == 0)">
                            &lt; 이전 주
                        </button>
                        <span class="mx-3 text-muted">@WeekDateRangeLabel</span>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="() => ChangeWeek(1)" disabled="@(_selectedWeekIndex >= _weeksInMonth.Count - 1)">
                            다음 주 &gt;
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header text-center">
                        <h5 class="card-title mb-0">판매 통계</h5>
                    </div>
                    <div class="d-flex justify-content-center align-items-end my-3">
                        <button style="width: 5.5rem" type="button" class="btn @(_selectedOption == OptionContent.Daily ? SelectedOptionClass : OptionClass)" @onclick="() => ShowStatistics(OptionContent.Daily)">일간</button>
                        <span class="mx-3" style="width: 0.1rem; height: 1.6rem; background: var(--bs-border-color)"></span>
                        <button style="width: 5.5rem" type="button" class="btn @(_selectedOption == OptionContent.Monthly ? SelectedOptionClass : OptionClass)" @onclick="() => ShowStatistics(OptionContent.Monthly)">월간</button>
                    </div>
                    <div class="card-body">
                        @if (_selectedDate is null && _selectedOption == OptionContent.Daily)
                        {
                            <div class="text-center text-muted mt-3">
                                @(_weeklySalesData.First().Amount > 0 ? "그래프를 눌러 일간 매출 통계를 확인하세요" : "해당 일에 판매된 메뉴가 없습니다.")
                            </div>
                        }
                        else
                        {   
                            if (_currentStatistics.Any())
                            {
                                <h4 class="mb-4">@GetRankingTitle()</h4>
                                <div class="list-container monospace-font" style="height: 40vh; overflow-y: auto;">
                                    <Virtualize Items="_currentStatistics" Context="stat">
                                        <ul class="list-group mt-3">
                                            <li class="list-group-item d-flex justify-content-between align-items-center border-secondary-subtle">
                                                <span class="fw-bold">@stat.ItemName</span>
                                                <div>
                                                    <span class="me-2">@CurrencyFormat(stat.Price)</span>
                                                    <span>@stat.Quantity.ToString("N0") 개</span>
                                                </div>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-end align-items-center border-secondary-subtle">
                                                <span>@(CurrencyFormat(stat.Price * stat.Quantity))</span>
                                            </li>
                                        </ul>
                                    </Virtualize>
                                </div>
                                <div class="mt-3 d-flex justify-content-end align-items-center fw-bold monospace-font">
                                    <span class="fw-bold me-2">총 : </span><span class="fw-bolder text-success">@(CurrencyFormat(_currentStatistics.Sum(i => i.Price * i.Quantity)))</span>
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted mt-3">해당 월에 판매된 메뉴가 없습니다.</div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>